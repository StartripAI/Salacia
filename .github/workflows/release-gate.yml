name: Release Gate

on:
  pull_request:
  workflow_dispatch:

jobs:
  release-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      - name: Prepare gate fixtures
        shell: bash
        run: |
          mkdir -p .salacia/plans .salacia/journal
          cat > .salacia/plans/release-gate-plan.json <<'JSON'
          {
            "contractId": "release-gate",
            "generatedAt": "2026-02-21T00:00:00.000Z",
            "summary": "release gate fixture with steps",
            "steps": [
              {
                "id": "fixture-step",
                "riskLevel": "low",
                "expectedArtifacts": [".salacia/journal/release-gate-exec.json"],
                "verification": ["node -e \"process.exit(0)\""]
              }
            ]
          }
          JSON

          cat > .salacia/journal/release-gate-exec.json <<'JSON'
          {
            "success": true,
            "verification": {
              "success": true
            }
          }
          JSON

      - name: Prepare advisors (mock-only)
        shell: bash
        run: |
          printf '%s\n' \
            '#!/usr/bin/env node' \
            'console.log(JSON.stringify({ vote: "approve", summary: "mock claude approve", evidenceRef: "mock-claude" }));' \
            > scripts/validate-claude.mjs

          printf '%s\n' \
            '#!/usr/bin/env node' \
            'console.log(JSON.stringify({ vote: "approve", summary: "mock gemini approve", evidenceRef: "mock-gemini" }));' \
            > scripts/validate-gemini.mjs

          chmod +x scripts/validate-claude.mjs scripts/validate-gemini.mjs

      - name: Run release gate (mock advisors, no external API keys)
        shell: bash
        run: |
          node scripts/release-gate.mjs \
            --plan .salacia/plans/release-gate-plan.json \
            --exec .salacia/journal/release-gate-exec.json \
            --require-convergence

      - name: Upload release gate report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-gate-report
          path: .salacia/journal/release-gate-*.json
