name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      - name: Prepare gate fixtures
        shell: bash
        run: |
          mkdir -p .salacia/plans .salacia/journal
          cat > .salacia/plans/release-gate-plan.json <<'JSON'
          {
            "contractId": "release-gate",
            "generatedAt": "2026-02-21T00:00:00.000Z",
            "summary": "release gate fixture with steps",
            "steps": [
              {
                "id": "fixture-step",
                "riskLevel": "low",
                "expectedArtifacts": [".salacia/journal/release-gate-exec.json"],
                "verification": ["node -e \"process.exit(0)\""]
              }
            ]
          }
          JSON

          cat > .salacia/journal/release-gate-exec.json <<'JSON'
          {
            "success": true,
            "verification": {
              "success": true
            }
          }
          JSON

      - name: Prepare advisors (mock-only)
        shell: bash
        run: |
          printf '%s\n' \
            '#!/usr/bin/env node' \
            'console.log(JSON.stringify({ vote: "approve", summary: "mock claude approve", evidenceRef: "mock-claude" }));' \
            > scripts/validate-claude.mjs

          printf '%s\n' \
            '#!/usr/bin/env node' \
            'console.log(JSON.stringify({ vote: "approve", summary: "mock gemini approve", evidenceRef: "mock-gemini" }));' \
            > scripts/validate-gemini.mjs

          chmod +x scripts/validate-claude.mjs scripts/validate-gemini.mjs

      - name: Run release gate (mock advisors, no external API keys)
        shell: bash
        run: |
          node scripts/release-gate.mjs \
            --plan .salacia/plans/release-gate-plan.json \
            --exec .salacia/journal/release-gate-exec.json \
            --require-convergence

      - name: Package
        run: npm pack

      - name: Generate release notes
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          cat > RELEASE_NOTES.md <<NOTES
          # ${TAG}

          See [CHANGELOG.md](CHANGELOG.md) for full details.

          ## Compatibility
          - Platforms: macOS, Linux, Windows (Codex via WSL on Windows)
          - Adapters: Claude, Codex, OpenCode, Cursor, Cline, VS Code, Antigravity

          ## Boundaries
          - Codex App informational-only (macOS Apple Silicon)
          - Antigravity delivered in bridge capability mode in v0.1
          NOTES

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          files: |
            salacia-*.tgz
